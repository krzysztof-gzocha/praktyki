name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Sprawdzanie kodu
        uses: actions/checkout@v2

      - name: Install MicroK8s
        uses: balchua/microk8s-actions@v0.4.0
        with:
          channel: '1.30/stable'
          addons: '["dns", "rbac", "hostpath-storage", "registry", "metrics-server", "ingress", "storage", "dashboard", "prometheus"]'

      - name: Instalacja Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

      - name: Kubernetes Cluster
        run: |
          sudo newgrp microk8s || true
          sudo microk8s kubectl cluster-info

      - name: Helm
        run: |
          newgrp microk8s || true
          helm upgrade --install gitea-environment ./gitea-environment
          
      - name: Tworzenie podów z deployment.yaml
        run: |
          if [ -f deployment.yaml ]; then
              sudo microk8s kubectl apply -f deployment.yaml
              echo "Pody zostały utworzone na podstawie deployment.yaml."
          else
              echo "Nie znaleziono pliku deployment.yaml."
          fi
      
      - name: Czekam 10 sekund na uruchomienie podów
        run: |
          echo "Czekam 10 sekund..."
          sleep 10
          
      - name: Sprawdzam deploymenty
        run: |
          echo "Sprawdzam dostępne deploymenty..."
          DEPLOYMENTS=$(sudo microk8s kubectl get deployments --no-headers | wc -l)
          if [ $DEPLOYMENTS -eq 0 ]; then
              echo "Nie znaleziono żadnych deploymentów. Zatrzymuję pipeline."
              exit 1
          else
              echo "Znaleziono $DEPLOYMENTS deploymentów. Przechodzę dalej."
          fi

      - name: Czekam 5 sekund na sprawdzenie stanu
        run: |
          echo "Czekam 5 sekund..."
          sleep 5

      - name: Sprawdzam stan deploymentów
        run: |
          echo "Sprawdzam stan deploymentów..."
          DEPLOY_STATUS=$(sudo microk8s kubectl get deployments --field-selector=status.availableReplicas!=1 --no-headers | wc -l)
          if [ $DEPLOY_STATUS -eq 0 ]; then
              echo "Wszystkie deploymenty mają dostępne repliki. Przechodzę do testów."
          else
              echo "Niektóre deploymenty nie mają dostępnych replik. Zatrzymuję pipeline."
              sudo microk8s kubectl get deployments
              exit 1
          fi

      - name: Uruchamianie testów
        run: |
          echo "Uruchamianie testów..."
          # Tutaj dodajesz swoje testy

      - name: Czekam 10 sekund przed zatrzymaniem deploymentu gitea
        run: |
          echo "Czekam 10 sekund przed zatrzymaniem deploymentu gitea..."
          sleep 10

      - name: Zatrzymuję deployment gitea
        run: |
          echo "Zatrzymuję deployment gitea..."
          sudo microk8s kubectl scale deployment gitea --replicas=0
          echo "Deployment gitea został zatrzymany (replicas=0)."

      - name: Sprawdzam stan deploymentów po zatrzymaniu deploymentu gitea
        run: |
          echo "Sprawdzam stan deploymentów po zatrzymaniu deploymentu gitea..."
          DEPLOYMENTS=$(sudo microk8s kubectl get deployments -o jsonpath='{.items[*].metadata.name}')
          
          for DEPLOY in $DEPLOYMENTS; do
            REPLICAS=$(sudo microk8s kubectl get deployment $DEPLOY -o jsonpath='{.status.availableReplicas}')
            
            if [ "$REPLICAS" == "0" ] || [ -z "$REPLICAS" ]; then
              echo "Deployment $DEPLOY nie ma dostępnych replik. Zatrzymuję pipeline."
              exit 1
            else
              echo "Deployment $DEPLOY ma dostępne repliki."
            fi
          done
          
          echo "Wszystkie pozostałe deploymenty mają dostępne repliki."

