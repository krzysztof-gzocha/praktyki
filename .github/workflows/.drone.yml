name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Sprawdzanie kodu
        uses: actions/checkout@v2

      - name: Install MicroK8s
        uses: balchua/microk8s-actions@v0.4.0
        with:
          channel: '1.30/stable'
          addons: '["dns", "rbac", "hostpath-storage", "registry", "metrics-server", "ingress", "storage", "dashboard", "prometheus"]'

      - name: Instalacja Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

      - name: Kubernetes Cluster
        run: |
          sudo newgrp microk8s || true
          sudo microk8s kubectl cluster-info

      - name: Helm
        run: |
          newgrp microk8s || true
          helm upgrade --install gitea-environment ./gitea-environment
          
      - name: Tworzenie podów z deployment.yaml
        run: |
          if [ -f deployment.yaml ]; then
              sudo microk8s kubectl apply -f deployment.yaml
              echo "Pody zostały utworzone na podstawie deployment.yaml."
          else
              echo "Nie znaleziono pliku deployment.yaml."
          fi
      
      - name: Czekam 10 sekund na uruchomienie podów
        run: |
          echo "Czekam 10 sekund..."
          sleep 10
          
      - name: Sprawdzam deploymenty
        run: |
          echo "Sprawdzam dostępne deploymenty..."
          DEPLOYMENTS=$(sudo microk8s kubectl get deployments --no-headers | wc -l)
          if [ $DEPLOYMENTS -eq 0 ]; then
              echo "Nie znaleziono żadnych deploymentów. Zatrzymuję pipeline."
              exit 1
          else
              echo "Znaleziono $DEPLOYMENTS deploymentów. Przechodzę dalej."
          fi

      - name: Czekam 5 sekund na uruchomienie podów
        run: |
          echo "Czekam 5 sekund..."
          sleep 5

      - name: Sprawdzam stan podów
        run: |
          echo "Sprawdzam stan podów..."
          POD_STATUS=$(sudo microk8s kubectl get pods --field-selector=status.phase!=Running --no-headers | wc -l)
          if [ $POD_STATUS -eq 0 ]; then
              echo "Wszystkie pody są w stanie Running. Przechodzę do testów."
          else
              echo "Niektóre pody nie są w stanie Running. Zatrzymuję pipeline."
              sudo microk8s kubectl get pods
              exit 1
          fi

      - name: Uruchamianie testów
        run: |
          echo "Uruchamianie testów..."
          # Tutaj dodajesz swoje testy

      - name: Zatrzymuję deployment gitea
        run: |
          echo "Zatrzymuję deployment gitea..."
          sudo microk8s kubectl scale deployment gitea --replicas=0
          echo "Deployment gitea został zatrzymany (replicas=0)."

      - name: Sprawdzam stan podów po usunięciu whoami
        run: |
          echo "Sprawdzam stan podów po usunięciu whoami..."
          POD_STATUS=$(sudo microk8s kubectl get pods --field-selector=status.phase!=Running --no-headers | wc -l)
          if [ $POD_STATUS -eq 0 ]; then
              echo "Wszystkie pozostałe pody są w stanie Running."
          else
              echo "Niektóre pody nie są w stanie Running. Zatrzymuję pipeline."
              sudo microk8s kubectl get pods
              exit 1
          fi
